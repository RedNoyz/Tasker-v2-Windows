name: Build and Upload Electron App

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Check out repository
        uses: actions/checkout@v3

      - name: ğŸ§© Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: ğŸ“¦ Install npm dependencies
        run: |
          npm install
          npm run rebuild

      # - name: ğŸ” Extract version from package.json
      #   id: get_version
      #   run: |
      #     echo "version=$(node -p "require('./package.json').version")" >> $env:GITHUB_ENV

      # - name: ğŸ” Verify version matches GitHub Release tag
      #   run: |
      #     $expectedTag = "v${{ env.version }}"
      #     $actualTag = "${{ github.event.release.tag_name }}"
      #     echo "Expected tag: $expectedTag"
      #     echo "Actual tag:   $actualTag"
      #     if ($expectedTag -ne $actualTag) {
      #       Write-Error "âŒ Version mismatch: package.json version $expectedTag vs release tag $actualTag"
      #       exit 1
      #     }

      - name: ğŸ”¨ Build Electron App
        run: |
          npm run build || npm run make  # depending on how you are building

      - name: ğŸ“¦ Zip output
        run: |
          mkdir bundle
          Copy-Item "dist/**" -Destination bundle/ -Recurse
          Compress-Archive -Path bundle/* -DestinationPath dist/Tasker.zip

      - name: ğŸš€ Upload assets to GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/Tasker.zip
          name: Tasker
          draft: false
          prerelease: ${{ github.event.release.prerelease }}
